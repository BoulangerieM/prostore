<form [formGroup]="orderForm" (ngSubmit)="onSubmit()">
  <h1>Commande professionnelle</h1>
  <p id="delayMessage">Compte tenu de nos méthodes de production, toute commande doit être passée
    <span>l'avant-veille</span> du jour
    de livraison (jours ouvrés uniquement).<br>
    Exemple : pour une livraison le mercredi, dernier délai le lundi à 18h.
  </p>
  <div fxLayout="row" fxLayoutAlign="center center" fxLayoutAlign.gt-sm="flex-start center">
    <mat-form-field fxFlex="40" fxFlex.lt-sm="100" appearance="outline" (click)="picker.open()">
      <mat-label>Date de livraison</mat-label>
      <input matInput required formControlName="deliveryDate" [min]="minimalDay" [matDatepicker]="picker"
        [matDatepickerFilter]="isItOpenToday" readonly />
      <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
      <mat-datepicker #picker touchUi></mat-datepicker>
      <mat-error *ngIf="orderForm.get('deliveryDate')?.invalid">{{
        getErrorMessage("deliveryDate", orderForm, errorMessages)
        }}</mat-error>
    </mat-form-field>
  </div>
  <div fxLayout="row" id="checkboxRow" fxLayoutAlign="center center" fxLayoutAlign.gt-sm="flex-start center">
    <mat-checkbox (change)="specificDeliveryTime($event.checked)" [checked]="selectDeliveryTime">
      Besoin d'une heure de livraison précise?
    </mat-checkbox>
  </div>
  <div fxLayout="row" fxLayoutAlign="center center" fxLayoutAlign.gt-sm="flex-start center">
    <mat-form-field *ngIf="selectDeliveryTime" fxFlex="40" fxFlex.lt-sm="100" appearance="outline">
      <mat-label>Heure de livraison</mat-label>
      <input [ngxTimepicker]="$any(datePicker)" min="06:00" max="12:00" [format]="24" readonly matInput
        formControlName="deliveryTime" />
      <ngx-material-timepicker #datePicker></ngx-material-timepicker>
    </mat-form-field>
  </div>
  <p id="deliveryMessage" *ngIf="showDeliveryMessage">
    Votre livraison vous sera livrée le
    {{ orderForm.get("deliveryDate")?.value | date: "fullDate" }}
    {{
    this.orderForm.get("deliveryTime")?.value
    ? "à " + this.orderForm.get("deliveryTime")?.value
    : "entre 6 heures et midi."
    }}
  </p>
  <!-- TODO: A SUPPRIMER SI PLUS PERTINENT A VOIR AVEC NICO !!!! sinon revoir le style !!!!-->
  <p class="warningMessage" *ngIf="showShortDeliveryMessage || showOrderNeedValidationMessage">
    <span> Attention, dû au délai court de votre commande: </span>
    <span *ngIf="showOrderNeedValidationMessage">
      <br />&nbsp;&nbsp;- Elle devra être validée par la boulangerie M.
      <span id="importantSentence">Sans retour de leur part dans l'heure, considérez la comme
        annulée.</span>
    </span>
    <span *ngIf="showShortDeliveryMessage">
      <br />&nbsp;&nbsp;- Certains produits ne sont pas disponibles. Ils ont
      été désactivés dans le formulaire.
    </span>
  </p>
  <!-- --------------------------------------------------- -->
  <mat-divider class="dividerOrderForm"></mat-divider>
  <h2>Produits</h2>
  <div *ngIf="!productList.length; else productContainer">
    <mat-spinner></mat-spinner>
  </div>
  <ng-template #productContainer>
    <mat-expansion-panel class="productCategory" *ngFor="let category of PRODUCTCATEGORY | keyvalue">
      <mat-expansion-panel-header class="productCategoryHeader">
        <mat-panel-title>{{ category.value }}</mat-panel-title>
      </mat-expansion-panel-header>

      <!-- <mat-card *ngFor="let product of filterProductByCategory(category.value)" fxFlex="49" fxFlex.lt-sm="100"
          [ngClass]="{
            unavailableItem: showShortDeliveryMessage && !product.shortDelivery
          }"> -->
      <mat-card *ngFor="let product of filterProductByCategory(category.value)" [ngClass]="{
                unavailableItem: showShortDeliveryMessage && !product.shortDelivery
              }">
        <mat-expansion-panel class="productExpansion">
          <mat-expansion-panel-header class="productExpansionHeader">
            <mat-panel-title>{{ product.name }}</mat-panel-title>
          </mat-expansion-panel-header>
          <div class="productExpansionBody">
            <p>{{ product.description }}</p>
            <mat-form-field fxFlex="100" appearance="outline" [formGroup]="commentFormGroup">
              <mat-label>Commentaire</mat-label>
              <textarea matInput [formControlName]="product.name"
                placeholder="Ex: boules tranchées, forme des pains, ..."></textarea>
            </mat-form-field>
            <div [formGroup]="sliceFormGroup" *ngIf="product.isSliceable">
              <mat-checkbox class="slicedCheckbox" [formControlName]="product.name">Tranché
              </mat-checkbox>
            </div>
          </div>
        </mat-expansion-panel>
        <mat-card-content class="cardPriceQuantity m-card-content" fxLayout="row wrap"
          fxLayoutAlign="space-between baseline">
          <div>
            Prix: {{ product.price.toFixed(2) }} € H.T. / {{ product.unit }}
          </div>
          <div>
            <mat-form-field [formGroup]="itemFormGroup" class="quantityInput" appearance="outline">
              <mat-label>Quantité</mat-label>
              <input matInput type="number" min="0" [formControlName]="product.name" />
            </mat-form-field>
          </div>
        </mat-card-content>
      </mat-card>
    </mat-expansion-panel>
  </ng-template>
  <mat-divider class="dividerOrderForm"></mat-divider>
  <div fxLayout="row" fxLayoutAlign="center center" fxLayoutAlign.gt-sm="flex-start center">
    <mat-form-field fxFlex="40" fxFlex.lt-sm="100" appearance="outline">
      <mat-label>Commentaires</mat-label>
      <textarea matInput formControlName="orderComment"
        placeholder="Ex: Déposer la livraison en arrière cuisine, ..."></textarea>
    </mat-form-field>
  </div>
  <div fxLayout="column wrap" fxLayoutAlign="center center" *ngIf="orderForm.get('totalPrice')?.value > 0">
    <h2 fxFlex="50">Résumé de la commande :</h2>
    <div fxFlex="50">
      <h3 *ngFor="let item of orderSummary | summaryPipe" [innerHtml]="item"></h3>
    </div>
    <h3 fxFlex="50" fxFlexOffset="2" *ngIf="orderForm.get('orderComment')?.value" class="orderCommentSummaryTitle">
      Commentaire de la commande :
    </h3>
    <h3 fxFlex="50" fxFlexOffset="2" *ngIf="orderForm.get('orderComment')?.value" class="summaryComment">
      <pre>
      {{ orderForm.get("orderComment")?.value }}
    </pre>
    </h3>
    <h2 fxFlex="50" fxFlexOffset="2">Prix total :</h2>
    <h2 fxFlex="50">
      {{ orderForm.get("totalPrice")?.value.toFixed(2) }} € H.T.
    </h2>
  </div>
  <div fxLayout="row wrap" fxLayoutAlign="center center" class="buttonRow">
    <button fxFlex="40" fxFlex.lt-sm="87" mat-raised-button type="submit">
      Commander
    </button>
  </div>
</form>